1.1 ç™»å…¥ API ä¿®æ”¹ï¼ˆå°‡ JWT å­˜å…¥ HttpOnly Cookieï¼‰
java
è¤‡è£½
ç·¨è¼¯
@PostMapping("/user/login")
public ResponseEntity<ApiResponse<Map<String, Object>>> login(@RequestBody Map<String, String> data, HttpSession session, HttpServletResponse response) {
    String sesstionAuthCode = session.getAttribute("authcode") + "";  // è·å–éªŒè¯ç 

    try {
        UserCert userCert = userLoginService.login(data.get("email"), data.get("password"), data.get("authcode"), sesstionAuthCode);

        // ç”Ÿæˆ JWT token
        String token = JwtUtil.generateToken(userCert.getUserId().toString());
        System.out.println("userID:" + userCert.getUserId().toString() + "[å·²ç¶“è½‰æ›æˆ] " + token);

        // æŠŠ userCert æ”¾é€² sessionï¼Œä¿æŒåŸæœ¬sessioné‚è¼¯ä¸å‹•
        session.setAttribute("userCert", userCert);

        // è¨­ç½® JWT Token åœ¨ HttpOnly Cookie ä¸­ï¼ˆå¢åŠ å®‰å…¨æ€§ï¼‰
        Cookie cookie = new Cookie("jwtToken", token);  // ä½¿ç”¨ httpOnly cookie å„²å­˜ token
        cookie.setHttpOnly(true); // é˜²æ­¢ JavaScript è¨ªå•ï¼Œé¿å… XSS æ”»æ“Š
        cookie.setMaxAge(3600);   // è¨­å®š cookie æœ‰æ•ˆæœŸç‚º 1 å°æ™‚
        cookie.setPath("/");      // é©ç”¨æ–¼æ•´å€‹æ‡‰ç”¨
        response.addCookie(cookie);  // è¨­ç½® Cookie

        // å›æ‡‰è³‡æ–™
        Map<String, Object> responseData = new HashMap<>();
        responseData.put("userCert", userCert);
        responseData.put("message", "ç™»å…¥æˆåŠŸ");

        return ResponseEntity.ok(ApiResponse.success(200, "ç™»å…¥æˆåŠŸ", responseData));
    } catch (RuntimeException e) {
        if (session.getAttribute("userCert") != null) {
            session.removeAttribute("userCert");  // å¦‚æœç™»å…¥å¤±æ•—ï¼Œæ¸…é™¤ session
        }
        return ResponseEntity.ok(ApiResponse.error(400, "ç™»å…¥å¤±æ•—:" + e.getMessage()));
    }
}
é‡é»ï¼š
åœ¨ç™»å…¥æˆåŠŸå¾Œï¼Œå°‡ JWT token å„²å­˜åˆ° HttpOnly Cookie ä¸­ï¼Œé¿å…å®ƒåœ¨å‰ç«¯æš´éœ²ã€‚

HttpOnly æœƒç¢ºä¿ cookie åªèƒ½ç”±ç€è¦½å™¨ç™¼é€çµ¦ä¼ºæœå™¨ï¼ŒJavaScript ç„¡æ³•ç›´æ¥è¨ªå•å®ƒï¼Œå¢åŠ å®‰å…¨æ€§ã€‚

ğŸ“š 2. å– Tokenï¼ˆå¾ Cookie ä¸­æå– JWTï¼‰
2.1 å¦‚ä½•åœ¨å¾Œç«¯å¾ Cookie ä¸­å–å‡º JWT
ç•¶ç”¨æˆ¶æ¯æ¬¡ç™¼é€è«‹æ±‚æ™‚ï¼Œæœƒå¸¶ä¸Š HttpOnly Cookieï¼Œå¯ä»¥å¾ HttpServletRequest ä¸­æå–å‡ºä¾†ã€‚

ä¾‹ï¼šç”¨æˆ¶è³‡æ–™ APIï¼Œå¾ Cookie ä¸­æå– JWT
java
è¤‡è£½
ç·¨è¼¯
@GetMapping("/user/profile")
public ResponseEntity<ApiResponse<UserCert>> getUserProfile(HttpServletRequest request, HttpSession session) {
    // å¾ request ä¸­å–å¾— Cookie
    Cookie[] cookies = request.getCookies();
    String jwtToken = null;

    if (cookies != null) {
        for (Cookie cookie : cookies) {
            if (cookie.getName().equals("jwtToken")) { // æŸ¥æ‰¾åç‚º jwtToken çš„ Cookie
                jwtToken = cookie.getValue(); // å–å¾—å…¶å€¼
                break;
            }
        }
    }

    if (jwtToken == null) {
        return ResponseEntity.ok(ApiResponse.error(400, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„ token"));
    }

    try {
        // è§£æ JWT tokenï¼Œä¸¦ç²å¾— userId
        String userId = JwtUtil.parseToken(jwtToken);  // å‡è¨­ä½ çš„ JwtUtil æœ‰ä¸€å€‹è§£æ JWT çš„æ–¹æ³•

        // é€™è£¡å¯é¸ï¼Œè‹¥ä½ éœ€è¦æ ¹æ“š JWT ä¸­çš„ userId æŸ¥æ‰¾ç”¨æˆ¶è³‡æ–™ï¼Œå¯ä»¥æŸ¥è©¢è³‡æ–™åº«
        UserCert userCert = userService.getUserById(userId);
        
        // å›æ‡‰ user è³‡è¨Š
        return ResponseEntity.ok(ApiResponse.success(200, "ç²å–ç”¨æˆ¶è³‡æ–™æˆåŠŸ", userCert));
    } catch (Exception e) {
        return ResponseEntity.ok(ApiResponse.error(400, "ç„¡æ•ˆçš„ token"));
    }
}
é‡é»ï¼š
åœ¨é€™è£¡ï¼Œæˆ‘å€‘é€šé HttpServletRequest ä¾†å–å‡ºæ‰€æœ‰ cookiesï¼Œä¸¦å°‹æ‰¾åç‚º jwtToken çš„ cookieã€‚

ä¸€æ—¦å–å‡º tokenï¼Œå¯ä»¥è§£æå®ƒä¸¦ä½¿ç”¨å…¶ä¸­çš„è³‡æ–™ï¼ˆå¦‚ userIdï¼‰ä¾†åŸ·è¡Œå¾ŒçºŒæ“ä½œã€‚

ğŸ“š 3. ç™»å‡º APIï¼ˆæ¸…é™¤ Session å’Œ Cookieï¼‰
ç™»å‡ºæ™‚ï¼Œæˆ‘å€‘è¦æ¸…é™¤ session å’Œ cookieã€‚

3.1 ç™»å‡º API ä¿®æ”¹ï¼ˆæ¸…é™¤ Session å’Œ Cookieï¼‰
java
è¤‡è£½
ç·¨è¼¯
@GetMapping("/user/logout")
public ResponseEntity<ApiResponse<String>> logout(HttpServletRequest request, HttpServletResponse response, HttpSession session) {
    // æ¸…é™¤ session ä¸­çš„ç”¨æˆ¶è³‡æ–™
    session.invalidate();  // ç„¡è«–å¦‚ä½•ï¼Œå…ˆæ¸…é™¤ session

    // æ¸…é™¤ HttpOnly Cookie ä¸­çš„ JWT token
    Cookie cookie = new Cookie("jwtToken", null); // å°‡ cookie è¨­ç‚º nullï¼Œå¯¦éš›ä¸Šæœƒä½¿å®ƒç„¡æ•ˆ
    cookie.setHttpOnly(true);
    cookie.setMaxAge(0);  // è¨­å®š cookie ç«‹å³éæœŸ
    cookie.setPath("/");  // è¦æ¸…é™¤æ•´å€‹ç¶²ç«™ç¯„åœçš„ cookie
    response.addCookie(cookie);  // æ›´æ–°ç€è¦½å™¨

    return ResponseEntity.ok(ApiResponse.success(200, "ç™»å‡ºæˆåŠŸ"));
}