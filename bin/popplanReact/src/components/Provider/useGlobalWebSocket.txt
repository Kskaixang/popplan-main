import { useRef, useEffect, useState, useContext } from 'react';
import SockJS from 'sockjs-client';
import { Client } from '@stomp/stompjs';
import { SessionContext } from './SessionProvider';

// STOMP ä¸»é€šé“ Hookï¼ˆå…¨åŸŸï¼‰
export const useGlobalWebSocket = () => {
  const { isLoggedIn, user } = useContext(SessionContext);
  const userId = user?.userId; // é˜²æ­¢ user ç‚º null æ™‚å ±éŒ¯

  const clientRef = useRef(null);
  const [connected, setConnected] = useState(false);

  useEffect(() => {
    if (!isLoggedIn || !userId) return;

    const socket = new SockJS('http://localhost:8080/websocket');
    const client = new Client({
      webSocketFactory: () => socket,
      reconnectDelay: 5000,
    });

    client.onConnect = () => {
      console.log('ğŸŒ ä¸»é€šé“ WebSocket é€£ç·šæˆåŠŸ');
      setConnected(true);

      client.subscribe(`/topic/notification/${userId}`, (message) => {
        const msg = JSON.parse(message.body);
        console.log('ğŸ”” æ”¶åˆ°é€šçŸ¥ï¼š', msg);
        // ğŸ‘‰ å¯ä»¥åœ¨é€™è£¡å‘¼å«é€šçŸ¥ç³»çµ±ã€å­˜åˆ° stateã€dispatch ç­‰
      });
    };

    client.onStompError = (error) => {
      console.error('âŒ STOMP éŒ¯èª¤:', error);
    };

    client.activate();
    clientRef.current = client;

    return () => {
      console.log('ğŸ›‘ ä¸»é€šé“ WebSocket ä¸­æ–·');
      client.deactivate();
      setConnected(false);
    };
  }, [isLoggedIn, userId]);

  return {
    client: clientRef.current,
    connected,
  };
};
